# RAG COT Chain 流程图

## 整体架构流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    run_rag_cot_evaluation()                 │
│                     主评估函数                               │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  1. load_test_cases()                 │
        │     从 testcases.py 加载测试用例       │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  2. 初始化工具                          │
        │     - LLM                              │
        │     - UserProfileTool                  │
        │     - ContextUnderstandingTool         │
        │     - DeviceLookupTool                 │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  3. 对每个测试用例循环评估              │
        │     for test_case in filtered_cases:   │
        │         evaluate_test_case(...)        │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  4. 统计汇总结果                        │
        │     - 准确率                           │
        │     - 按类型统计                        │
        │     - 保存日志                          │
        └───────────────────────────────────────┘
```

## 单个测试用例评估流程

```
┌─────────────────────────────────────────────────────────────┐
│              evaluate_test_case(test_case)                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  初始化上下文状态                      │
        │  - user_preferences = {}              │
        │  - device_facts = []                   │
        │  - context_summary = None              │
        │  - chain_history = []                  │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  多步骤循环 (最多 25 步)               │
        │  for step_idx in range(1, 26):         │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  步骤 1: 构建规划提示词                │
        │  build_chain_planner_prompt()         │
        │  - 当前用户指令                        │
        │  - 已检索的上下文状态                  │
        │  - 可用工具列表                        │
        │  - 之前的步骤历史                      │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  步骤 2: LLM 规划决策                  │
        │  planner_response = llm([planner_msg])│
        │  parse_planner_response()              │
        │  返回: {action, thought, query}       │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  步骤 3: 根据 action 执行相应操作      │
        └───────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│preference_   │  │device_       │  │context_      │
│lookup        │  │lookup        │  │summary       │
│              │  │              │  │              │
│检索用户偏好   │  │查找相关设备   │  │生成上下文摘要 │
│              │  │              │  │              │
│user_prefs =  │  │device_facts  │  │context_summary│
│tool.run()    │  │.append()     │  │= tool.run()  │
└──────────────┘  └──────────────┘  └──────────────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  步骤 4: 检查是否为 final_decision    │
        │  if action == "final_decision":       │
        │      break  # 退出循环                 │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  最终决策阶段                         │
        │  1. 确保有 context_summary            │
        │  2. 构建 COT 推理提示词              │
        │     build_cot_prompt()               │
        │  3. LLM 进行推理                      │
        │     final_response = llm([...])      │
        │  4. 解析结果                          │
        │     parse_llm_response()            │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  评估结果                              │
        │  is_correct = (predicted == ground_truth)│
        │  保存日志到 JSON 文件                  │
        └───────────────────────────────────────┘
```

## COT 推理提示词结构

```
┌─────────────────────────────────────────────────────────────┐
│                    build_cot_prompt()                        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 任务说明                                                 │
│     - 你是决策模块                                            │
│     - 判断是否需要 human_interaction_tool                    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 使用场景规则                                              │
│     ✅ 需要: 模糊指代、缺少偏好、非标准表达、意图模糊        │
│     ❌ 不需要: 指令明确、可从数据库获取、上下文已消歧        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 置信度启发式规则                                          │
│     - 单一高匹配设备 → 使用该设备                            │
│     - 用户偏好提到类型 → 映射主观形容词                      │
│     - 环境抱怨 → 假设明显执行器                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 已检索的上下文                                            │
│     - 用户偏好 (user_preferences)                            │
│     - 历史交互片段 (user_memory_snippets)                    │
│     - 设备查找结果 (device_lookup_notes)                     │
│     - 上下文摘要 (context_summary)                           │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 推理步骤要求                                              │
│     Step 1 - Keyword analysis: 关键词分析                   │
│     Step 2 - Ambiguity check: 模糊性检查                     │
│     Step 3 - Information availability: 信息可用性            │
│     Step 4 - Decision: 最终决策                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  6. 输出格式要求                                              │
│     Conclusion:                                              │
│     Need / Do not need to use human_interaction_tool         │
└─────────────────────────────────────────────────────────────┘
```

## 工具调用流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    UserProfileTool                           │
│               (用户偏好检索工具)                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  输入: {query, user_name}              │
        │  查询: "What is the user's favorite TV show?"│
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  从 memory_bank.json 检索              │
        │  - 用户偏好数据库                       │
        │  - 历史交互记录                         │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  输出: 用户偏好字典                     │
        │  {"favorite_show": "The Office", ...} │
        └───────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    DeviceLookupTool                          │
│               (设备查找工具)                                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  输入: query = "TV"                    │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  1. 从 DocManager 获取设备元数据        │
        │     - 设备名称                         │
        │     - 设备能力 (capabilities)          │
        │     - 组件 (components)                │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  2. 从 device_state 获取状态快照        │
        │     - 当前设备状态                     │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  3. 计算匹配得分                        │
        │     - token_score: 关键词匹配          │
        │     - ratio_score: 字符串相似度         │
        │     - score = token_score * 2 + ratio  │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  4. 返回前 N 个匹配设备                │
        │     [匹配度 5.2] Living Room TV (...) │
        └───────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              ContextUnderstandingTool                        │
│              (上下文理解工具)                                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  输入:                                 │
        │  - user_command                        │
        │  - user_preferences                    │
        │  - device_state                       │
        │  - user_memory_snippets                │
        │  - device_lookup_notes                 │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  汇总所有信息为结构化文本               │
        │  - Command focus: ...                  │
        │  - Preference snapshot: ...            │
        │  - Device environment: ...              │
        │  - History context: ...                 │
        │  - Device lookup insights: ...          │
        └───────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │  输出: 上下文摘要字符串                 │
        └───────────────────────────────────────┘
```

## 决策树示例

```
用户指令: "turn it off"
    │
    ▼
┌───────────────────────────────────────┐
│  步骤 1: 设备查找                      │
│  device_lookup("turn it off")         │
│  → 找到多个设备: TV, Light, Fan        │
└───────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────┐
│  步骤 2: 检查上下文                    │
│  - 最近操作: 打开了 TV                 │
│  - 当前状态: TV 是 on                  │
└───────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────┐
│  步骤 3: 推理判断                      │
│  - "it" 指代最近操作的设备 (TV)        │
│  - 上下文已能消歧                      │
│  → 不需要 human_interaction_tool       │
└───────────────────────────────────────┘

─────────────────────────────────────────

用户指令: "put on my favorite show"
    │
    ▼
┌───────────────────────────────────────┐
│  步骤 1: 偏好查找                      │
│  preference_lookup("favorite show")   │
│  → 未找到相关偏好                      │
└───────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────┐
│  步骤 2: 历史查找                      │
│  → 历史记录中也没有相关信息            │
└───────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────┐
│  步骤 3: 推理判断                      │
│  - "my favorite show" 需要个性化信息  │
│  - 无法从数据库/历史中获取             │
│  → 需要 human_interaction_tool         │
└───────────────────────────────────────┘
```

## 数据流示例

```
测试用例: turn_on_tv
    │
    ├─ user_command: "Amal: turn on the TV"
    ├─ device_state: {...}
    └─ requires_human_interaction: False
        │
        ▼
┌───────────────────────────────────────┐
│  提取用户名: "amal"                    │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│  规划步骤 1: device_lookup            │
│  query: "turn on the TV"              │
│  → 找到设备: Living Room TV           │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│  规划步骤 2: context_summary          │
│  → 生成上下文摘要                      │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│  规划步骤 3: final_decision           │
│  → 触发 COT 推理                      │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│  COT 推理结果:                        │
│  - 指令明确 ("turn on the TV")        │
│  - 设备已找到 (Living Room TV)        │
│  - 不需要澄清                          │
│  → predicted: False                   │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│  评估:                                │
│  predicted (False) == ground_truth (False)│
│  → is_correct: True                   │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│  保存日志:                             │
│  test_logs/rag_cot/.../turn_on_tv.json│
└───────────────────────────────────────┘
```



