# RAG COT 深层推理优化说明

## 优化目标

提高 LLM 的深层推理能力，使其能够从用户指令的表面含义推断出深层意图，减少不必要的 `human_interaction_tool` 调用。

### 典型问题案例

**案例 1：电话来了，调整电视音量**
- **用户指令**: "I am getting a call, adjust the volume of the TV"
- **表面理解**: 需要调整音量，但缺少具体音量值
- **深层意图**: 用户要接电话，电视音量太响会干扰，应该**调低音量**（而不是调高或询问具体值）
- **优化前**: LLM 认为缺少音量值，需要询问用户
- **优化后**: LLM 应该通过常识推理，理解情境并推断出应该调低音量

**案例 2：太亮了**
- **用户指令**: "It is too bright in the dining room"
- **深层意图**: 用户抱怨环境太亮，应该**调暗灯光**（而不是调亮或询问具体亮度）

**案例 3：要去睡觉了**
- **用户指令**: "I am going to sleep. Change the bedroom light"
- **深层意图**: 用户要睡觉，应该**调暗或关闭灯光**（而不是调亮）

## 主要优化内容

### 1. 增强 COT Prompt 的深层推理指导

在 `build_cot_prompt` 函数中添加了**深层意图推理**部分：

#### 新增内容：

1. **情境上下文分析 (Situational Context Analysis)**
   - 分析命令中隐含的更大情境
   - 从情境推断用户的真实意图
   - 示例：电话来了 → 需要安静环境 → 调低音量

2. **常识推理 (Common Sense Reasoning)**
   - 应用日常逻辑和社会惯例
   - 电话来了 + 调整音量 → 几乎总是"调低"
   - 太亮/太冷/太响 → 需要相反的操作（调暗/调热/调低）

3. **默认动作推断 (Default Action Inference)**
   - 当意图明确但缺少具体值时，推断合理的默认动作
   - "调整音量"在电话时 → 降低50%或静音
   - "适当模式"对于油腻盘子 → 使用强力洗涤模式

4. **上下文消歧 (Contextual Disambiguation)**
   - 使用情境来消除歧义
   - "Turn it off" 当用户离开时 → 关闭电视

#### 更新的推理步骤：

从原来的4步扩展到5步：
1. **表面分析** (Surface-level analysis)
2. **深层意图推理** (Deep intent inference) - **新增**
3. **信息缺口分析** (Information gap analysis) - **增强**
4. **歧义解决** (Ambiguity resolution) - **新增**
5. **决策** (Decision)

### 2. 优化 Chain Planner Prompt

在 `build_chain_planner_prompt` 函数中添加了**先推理，再检索**的指导：

- **推理优先**: 在请求额外信息之前，先应用深层推理
- **情境推断**: 分析情境并推断底层意图
- **常识应用**: 使用日常逻辑填补空白
- **避免过度检索**: 只检索真正需要且无法推断的信息

### 3. 改进 Few-shot 示例

#### 示例生成逻辑优化：

- 为不需要 `human_interaction` 的示例添加了详细的深层推理说明
- 特别处理了以下场景：
  - **电话 + 音量调整**: 展示如何从情境推断出应该调低音量
  - **环境抱怨** (太亮/太冷/太响): 展示如何推断纠正动作
  - **睡觉 + 灯光**: 展示如何从情境推断出应该调暗

#### Few-shot 示例选择优化：

优先选择需要深层推理的测试用例作为示例，特别是：
- 包含 `("call", "volume")` 组合的用例
- 包含 `("sleep", "light")` 组合的用例
- 包含环境抱怨关键词的用例（"too bright", "too cold", "too loud"）
- 包含 `("greasy", "mode")` 或 `("appropriate", "mode")` 的用例

### 4. 增强的启发式规则

添加了新的启发式规则：

- **情境推断**: 如果命令提到情境（电话、睡觉、太亮/太冷/太响），从常识推断明显动作
- **方向推断**: 如果命令指定方向（调整、改变、设置）但没有值，从上下文推断方向
- **默认值推断**: 当方向明确但值缺失时，使用合理默认值
- **环境抱怨**: 假设明显的纠正动作（太亮时调暗灯光，太响时调低音量）

## 预期效果

### 优化前的问题

1. **过度依赖用户偏好**: 即使可以通过常识推断，也会因为缺少用户偏好而请求帮助
2. **缺乏情境理解**: 无法从情境（如"电话来了"）推断出用户的真实意图
3. **缺少默认值推断**: 即使方向明确（如"调低"），也会因为缺少具体值而请求帮助

### 优化后的改进

1. **深层推理能力**: LLM 能够分析情境并推断用户的真实意图
2. **常识应用**: 能够应用日常逻辑填补信息空白
3. **自主性提升**: 减少不必要的 `human_interaction_tool` 调用，提高系统自主性
4. **用户体验**: 用户不需要频繁回答澄清问题，系统能够"理解"用户的意图

## 使用建议

1. **测试验证**: 运行评估脚本，检查 `getting_call_tv_too_loud` 等测试用例的准确率是否提升
2. **监控效果**: 关注以下指标：
   - 整体准确率
   - "不需要 human_interaction" 场景的正确率
   - 深层推理相关测试用例的正确率
3. **持续优化**: 根据测试结果，可以进一步：
   - 添加更多情境推理规则
   - 扩展常识推理的覆盖范围
   - 优化 few-shot 示例的选择策略

## 代码变更位置

1. **`build_cot_prompt` 函数** (第 452-646 行)
   - 添加了深层推理指导部分
   - 更新了推理步骤格式
   - 增强了启发式规则

2. **`build_chain_planner_prompt` 函数** (第 649-723 行)
   - 添加了"先推理，再检索"的指导
   - 强调了情境推断的重要性

3. **`run_rag_cot_evaluation` 函数** (第 1070-1186 行)
   - 优化了 few-shot 示例选择逻辑
   - 优先选择需要深层推理的示例

4. **Few-shot 示例生成逻辑** (第 609-641 行)
   - 为不需要 human_interaction 的示例添加了详细的深层推理说明
   - 特别处理了常见的情境推理场景


